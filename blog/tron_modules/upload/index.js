var upload=new Class({initialize:function(A){this.config=this.mock({folder:"",exts:["jpg","gif","bnp"],size:8*1024*1024*10},A);this.achor=0;this.moves=0},speed:1024,object:new ActiveXObject("Adodb.Stream"),nameSpace:{},achor:0,moves:0,error:{"0":"上传或记录单个文件成功","403":"文件上传类型不合法","405":"文件大小超过了系统允许的最大单个上传容量"},fs:new ActiveXObject("Scripting.FileSystemObject")});upload.add("randoms",function(D){var A="123456789poiuytrewqasdfghjklmnbvcxzQWERTYUIPLKJHGFDSAZXCVBNM";var C="";for(var B=0;B<D;B++){C+=A.charAt(Math.ceil(Math.random()*100000000)%A.length)}return C});upload.add("mock",function(C,A){for(var B in A){C[B]=A[B]}return C});upload.add("getAllHttpBinray",function(){var B=Request.TotalBytes,C=0,D,A=this.speed;if(B<A){A=B}var E=new ActiveXObject("Adodb.Stream");E.Type=1;E.Mode=3;E.Open();while(C<B){if(B-C<A){A=B-C}E.Write(Request.BinaryRead(A));C+=A}E.Position=0;D=E.Read();E.Close();E=null;return D});upload.add("beforeUpload",function(){var A=true;if(this.config.beforeUpload&&typeof this.config.beforeUpload==="function"){A=this.config.beforeUpload.call(this)}return A});upload.add("httpload",function(C){if(this.beforeUpload()===false){return this.nameSpace}if(C&&typeof C==="function"){this.config.complete=C}this.AllBinary=this.getAllHttpBinray();this.text=this.AllBinary;this.CutLine=VB_DRIVER(this.AllBinary);this.object.Type=1;this.object.Mode=3;this.object.Open();this.object.Position=0;this.object.Write(this.AllBinary);var B=0;while((B=VB_INSERTB(this.AllBinary,this.CutLine))>0){var A=this.httpBlock(B);if(!A){break}}this.object.Close();delete this.object;this.complete();return this.nameSpace});upload.add("httpBlock",function(C){var D=C+VB_LENB(this.CutLine)+VB_LENB(VB_BNCRLF),A=VB_INSERTBS(D,this.AllBinary,this.CutLine)-VB_LENB(VB_BNCRLF),B;this.achor=this.moves+D;this.moves=this.moves+A;if(A>0){B=VB_MIDBS(this.AllBinary,D,A-D);this.AllBinary=VB_MIDB(this.AllBinary,A+1);this.httpGetMessage(B);return true}else{return false}});upload.add("httpGetMessage",function(B){var E=VB_INSERTB(B,VB_DOUBLEBNCRLF);if(E>0){var F=this.httpBinaryToText(VB_MIDBS(B,1,E));var A=/name\=\"([^\"]+)\"/.exec(F),I=/filename\=\"([^\"]+)\"/.exec(F),G,D,H,C=this.achor+E+VB_LENB(VB_DOUBLEBNCRLF)-1;if(A&&A[1]){G=A[1];this.nameSpace[G]={file:false,error:0};var J=VB_MIDB(B,E+VB_LENB(VB_DOUBLEBNCRLF));if(I&&I[1]){D=I[1];H=D.split(".").slice(-1).join(".");this.nameSpace[G]["uploadName"]=D;this.nameSpace[G]["ext"]=H;this.nameSpace[G]["file"]=true;this.nameSpace[G]["size"]=this.moves-C;this.nameSpace[G]["dir"]=/\\$/.test(this.config.folder)?this.config.folder:this.config.folder+"\\";if(!this.checkFileExts(H)){this.nameSpace[G]["error"]=403;return}if(!this.checkFileSize(this.config.size,this.nameSpace[G]["size"])){this.nameSpace[G]["error"]=405;return}this.nameSpace[G]["filename"]=this.makeFileName(D.split(".").slice(0,-1).join("."),H);this.autoCreateFolder(this.nameSpace[G]["dir"]);this.nameSpace[G]["filepath"]=this.nameSpace[G]["dir"]+this.nameSpace[G]["filename"];var K=this.checkReSolvePathName(this.nameSpace[G]["dir"]+this.nameSpace[G]["filename"]);if(K&&K.length&&K.length>0){this.nameSpace[G]["filepath"]=K}this.nameSpace[G]["value"]=this.nameSpace[G]["filepath"];this.httpSaveFile(C,this.nameSpace[G]["size"],this.nameSpace[G]["filepath"]);this.done(this.nameSpace[G])}else{this.nameSpace[G]["value"]=this.httpBinaryToText(J)}}}});upload.add("checkFileExts",function(D){var A=true,C=-1;if(this.config.exts==="*"){return true}if(this.config.exts&&this.config.exts.length>0){if(!readVariableType(this.config.exts,"array")){this.config.exts=[this.config.exts]}for(var B=0;B<this.config.exts.length;B++){if(this.config.exts[B].toLowerCase()===D.toLowerCase()){C=B;break}}if(C===-1){A=false}}return A});upload.add("checkFileSize",function(B,A){return B>0?A<=B:true});upload.add("makeFileName",function(A,C){if(!this.config.rename){this.config.rename="{$timestrap}.{$ext}"}var B=this;return this.config.rename.replace(/\{\$timestrap\}/ig,new Date().getTime()).replace(/\{\$normal\}/ig,A).replace(/\{\$ext\}/,C).replace(/\{\$random\:(\d+)\}/ig,function(D){return B.randoms(D[1])})});upload.add("checkReSolvePathName",function(A){if(this.config.resolve&&typeof this.config.resolve==="function"){return this.config.resolve.call(this,A)}});upload.add("done",function(A){if(this.config.success&&typeof this.config.success==="function"){this.config.success.call(this,A)}});upload.add("autoCreateFolder",function(B){var C=Server.MapPath("/"),D=B.replace(C,""),A=D.replace(/^\\/,"").split("\\");for(var E=0;E<A.length;E++){C+="\\"+A[E];if(!this.fs.FolderExists(C)){this.fs.CreateFolder(C)}}return this.fs.FolderExists(B)});upload.add("complete",function(){if(this.config.complete&&typeof this.config.complete==="function"){this.config.complete.call(this,this.nameSpace)}});upload.add("httpBinaryToText",function(C){var A=new ActiveXObject("Adodb.Stream"),B;A.Type=2;A.Mode=3;A.Open();A.WriteText(C);A.Position=0;A.CharSet=modules.charset;A.Position=2;B=A.ReadText();A.Close();A=null;return B});upload.add("httpSaveFile",function(B,A,C){var D=new ActiveXObject("Adodb.Stream");D.Type=1;D.Mode=3;D.Open();this.object.Position=B-1;this.object.CopyTo(D,A);D.SaveToFile(C,2);D.Close();D=null});module.exports=upload;